#!/bin/bash

# File        : .wopsys
# Date        : 07.02.17
# Author      : Jonas J. Solsvik
# Email       : jonasjso@stud.ntnu.no 
# Description : A system for downloading files from any teacher's website
#                in any subject on NTNU GjÃ¸vik specifically.

root=~/wopsys

	# CONFIG - NO TOUCHY
logurl=https://raw.githubusercontent.com/Arxcis/wopsys/master/wopsys_base.log
logbase=${root}/wopsys_base.log 
logfile=${root}/wopsys.log			     	# Logfile - relative path

	# CONFIG
url=http://www.ansatt.hig.no/erikh/opsys/	# Main repository
editor=subl									# Default editor




function wops () {

		# TempSTRINGS
	filename=		  		
	searchstring=
	currentdir=

		# STANDARD UNIX COMMAND INTERPRETING SWITCH
	while [ $# -gt 0 ]
	do 
		case "$1" in 
			-f) filename=$2;
				curl ${url}${filename} > ${filename} 
				shift;;

			-p) filename=$2;  # Shift because consume two arguments
				curl ${url}${filename};
				shift;; 

			-l) echo -e "\nKnown files:";
				grep "" ${logfile} -n;
				break;;

			-s) searchstring=$2;

			    echo -e "\nSearching DB...";
			    grep ${searchstring} ${logfile} -n
			    break;;

			-h) 
				echo -e "\nValid commands:\n" \
					 "   [filename] to save file\n" \
					 "   -p to print file\n" \
					 "   -h to help\n";;

			-u) 
				echo -e "\nUpdating file DB";

				# curl ${logurl} > ${logbase};
 				# 	# Syncing local with temp base log
				# sort ${logfile} ${logbase} | uniq > ${logfile};

				currentdir=$PWD;
				cd ${root}/;
				
				echo $PWD;
				echo $root; 
				echo $currentdir;
				#git add ${logbase};
				#git commit -m "Updating ${logbase}";
				#git push origin master;	

				#rm -rf ${logbase};	

				cd $currentdir;

				break;;

            -*) echo -e "\nCommand not handled"; break;;

			*.*)  					
				filename=$1;
				curl ${url}${filename} > ${filename};
				${editor} ${filename};
				break;;  			 # Terminate while loop
				
			*) echo "Printing root ${root}";
			   break;;
		esac
		shift
	done

		# DUMP FILENAME TO HISTORY

		# echo "Filename is:" ${filename}  # debug
	if [ ! -z ${filename} ]						# If user input filename
	then
		if grep ${filename} ${logfile}	# If filname not exist in history
		then
			echo -e "\n" ${filename} " already exists in cache....";
		else
			echo -e "\nAdding " ${filename} " to cache...";
			echo ${filename} >> ${logfile};
		fi 
	fi

}
